# -- TODO:
# --
chatroom_regex = /(\d*)$/g
# chatroom_id = document.url.match(chatroom_regex)

App.game = App.cable.subscriptions.create {channel: "GameChannel", room_id: parseFloat("http://localhost:3000/chatrooms/1".match(chatroom_regex)[0]) },
  connected: ->
    # Called when the subscription is ready for use on the server
    console.log("connected")
    @perform 'get_user_count'

  disconnected: ->
    # Called when the subscription has been terminated by the server
    # @perform 'disconnected'

  received: (data) ->
    # Called when there's incoming data on the websocket for this channel
    if data['user_count']?
      $('#user_count').html("Current users: #{data['user_count']}")

    if data['content']
      messageBlock = '''
        <div class="user_chat_message">
          <div class="chat_msg_sender">
            <%= image_tag 'pb2.gif', class: 'chat_user_img' %>
            <a href="#"><span class="comment_header chat_msg_username">''' + data['user_name'].replace(/^\s+|\s+$/g, "") + ''':</span></a>
          </div>
          <div class="user_msg_info">
            <p>''' + data['time'] + '''</p>
          </div>
          <div class="user_chat_msg_div">
            <p class="user_chat_msg_p">''' + data['content'] + '''</p>
          </div>
        </div>
      '''
      $('.chat_message_area before').append(messageBlock)
      console.log("received: #{data['content']}")

  speak: (content) ->
    @perform 'speak', content: content
